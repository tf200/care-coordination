# PROJECT KNOWLEDGE BASE

**Generated:** 2026-01-22
**Commit:** e1f00e3
**Branch:** main

## OVERVIEW

Go-based care coordination API for healthcare client management. Stack: Gin + PostgreSQL (sqlc) + Redis + MinIO + WebSocket.

## STRUCTURE

```
care-coordination/
├── api/              # HTTP server setup, route registration
├── cmd/              # Entry points (app, worker, migrate, admin, seed, nanoid)
├── features/         # Domain modules (17 features, uniform structure)
├── lib/              # Shared libraries (db, token, websocket, ratelimit, etc.)
├── internal/mocks/   # Generated service mocks
├── docs/             # Swagger + WebSocket documentation
└── scripts/          # Deploy and key generation
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Add new feature | `features/{name}/` | Use `make add-feature NAME=xxx` scaffolds interface/service/dto/handler |
| Add API endpoint | `features/{name}/handler.go` | Use `SetupXxxRoutes()` pattern |
| Add database query | `lib/db/queries/{domain}.sql` | Run `make sqlc` after |
| Add migration | `lib/db/migrations/` | `NNNNNN_name.up.sql` / `.down.sql` |
| Auth/middleware | `features/middleware/` | AuthMdw, RoleMdw, RateLimitMdw |
| WebSocket | `lib/websocket/` | Hub manages connections, tickets for auth |
| Config/env vars | `lib/config/config.go` | All env vars defined here |
| Rate limiting | `lib/ratelimit/` | Redis primary, memory fallback |

## FEATURE MODULE PATTERN

Every feature in `features/` follows this structure:

```
features/{name}/
├── interface.go   # Service interface (go:generate mockgen directive)
├── service.go     # Business logic, database calls via store
├── handler.go     # HTTP handlers, SetupXxxRoutes(router)
├── dto.go         # Request/response structs with validation tags
├── errors.go      # Domain-specific errors (var ErrXxx = errors.New(...))
└── *_test.go      # Handler and service tests (some features)
```

**Handler pattern:**
```go
type XxxHandler struct {
    service XxxService
    mdw     *middleware.Middleware
}

func (h *XxxHandler) SetupXxxRoutes(router *gin.Engine) {
    group := router.Group("/xxx")
    group.Use(h.mdw.AuthMdw())
    group.POST("/", h.Create)
    // ...
}
```

## CONVENTIONS

| Area | Convention |
|------|------------|
| IDs | NanoID (not UUID) - see `lib/nanoid/` |
| Module name | Typo in go.mod: `care-cordination` (missing 'o') - keep as-is |
| Logging | Zap structured logging via `lib/logger/` |
| Responses | Use `lib/resp/` helpers: `resp.Success()`, `resp.Error()` |
| Errors | Domain errors in `errors.go`, switch-case in handlers |
| Transactions | Use `store.ExecTx()` - sets RLS context automatically |
| Mocks | `go:generate mockgen` in interface.go, outputs to `internal/mocks/` or local `mocks/` |

## ANTI-PATTERNS (DO NOT)

| Forbidden | Reason |
|-----------|--------|
| Edit `lib/db/sqlc/*.sql.go` | Auto-generated by sqlc, run `make sqlc` instead |
| Edit `docs/docs.go` | Auto-generated by swag, run `make swagger` instead |
| Edit `**/mocks/*.go` | Auto-generated by mockgen |
| Skip RLS context | Always use `store.ExecTx()` for writes, it sets `app.current_user_id` |
| Direct pgxpool queries | Use Store/Queries from `lib/db/sqlc/` |

## COMMANDS

```bash
# Development
make sqlc              # Regenerate query code from lib/db/queries/*.sql
make swagger           # Regenerate API docs from handler annotations
make add-feature NAME=x  # Scaffold new feature module

# Database
make migrate-up        # Run all pending migrations
make migrate-down      # Rollback all migrations
make migrate-up1       # Run next migration only
make migrate-down1     # Rollback last migration
make migrate-version   # Check current migration version
make seed              # Seed sample data
make admin             # Create admin user

# Docker
make docker-rebuild    # Rebuild and restart app container
make deploy            # SSH deploy via scripts/deploy.sh

# Testing
go test -v ./lib/db/sqlc/... -count=1  # Database integration tests
go test ./features/...                  # Feature tests
```

## ENTRY POINTS

| Binary | Path | Purpose |
|--------|------|---------|
| API Server | `cmd/app/main.go` | Main HTTP server (port from config) |
| Worker | `cmd/worker/main.go` | Background job runner (5-min notification checks) |
| Migrate | `cmd/migrate/main.go` | Database migrations |
| Admin | `cmd/admin/main.go` | Create admin user |
| Seed | `cmd/seed/main.go` | Populate sample data |

## DATABASE

- **PostgreSQL** with Row Level Security (RLS)
- **sqlc** for type-safe queries - queries in `lib/db/queries/`, generated code in `lib/db/sqlc/`
- **Migrations** in `lib/db/migrations/` using golang-migrate
- **Store pattern**: `db.NewStore(pool)` wraps Queries with transaction support

Key tables: users, employees, clients, locations, incidents, evaluations, appointments, notifications, audit_logs

## TESTING

- **DB tests**: Table-driven tests with `runTestWithTx()` - always rollback
- **Factories**: `CreateTestXxx()` in `lib/db/sqlc/testutil.go`
- **Mocks**: Service interfaces have mockgen directives
- See `lib/db/sqlc/README.md` for detailed testing patterns

## NOTES

- WebSocket auth uses ticket system (30s TTL) - see `docs/WEBSOCKET_NOTIFICATIONS.md`
- Audit logging is NEN7510/ISO27001 compliant with hash chains
- Client status transitions: `waiting_list` → `in_care` → `discharged` (with constraints)
- TODO in `features/rbac/handler.go`: "Add admin permission check" (incomplete)
