# lib/db/sqlc - Database Layer

## OVERVIEW

SQLC-generated database layer with Store pattern, transactions, and RLS support.

## STRUCTURE

```
sqlc/
├── *.sql.go          # AUTO-GENERATED from lib/db/queries/*.sql
├── models.go         # AUTO-GENERATED table structs and enums
├── querier.go        # AUTO-GENERATED query interface
├── db.go             # AUTO-GENERATED DBTX interface
├── store.go          # HAND-WRITTEN Store with ExecTx()
├── store_interface.go # HAND-WRITTEN StoreInterface for DI
├── *_tx.go           # HAND-WRITTEN complex transactions
├── testutil.go       # HAND-WRITTEN test factories
├── main_test.go      # HAND-WRITTEN test setup with testcontainers
├── *_test.go         # HAND-WRITTEN integration tests
└── mocks/            # AUTO-GENERATED by mockgen
```

## ANTI-PATTERNS (DO NOT)

| Forbidden | Do This Instead |
|-----------|-----------------|
| Edit `*.sql.go` files | Edit `lib/db/queries/*.sql`, run `make sqlc` |
| Edit `models.go`, `querier.go`, `db.go` | Run `make sqlc` to regenerate |
| Edit `mocks/*.go` | Run `go generate ./...` |
| Direct pool queries in services | Use `store.ExecTx()` for writes |

## KEY PATTERNS

**Transaction with RLS:**
```go
err := store.ExecTx(ctx, func(q *db.Queries) error {
    // RLS context auto-set from ctx user ID
    return q.CreateXxx(ctx, params)
})
```

**Complex transactions** - see `*_tx.go` files for multi-step operations.

## TESTING

See `README.md` for detailed test patterns. Key points:

- Use `runTestWithTx()` - always rolls back
- Use `CreateTestXxx()` factories from `testutil.go`
- Table-driven tests required
- Error helpers: `IsUniqueViolation()`, `IsForeignKeyViolation()`

## FK DEPENDENCY ORDER

```
User → Employee
Location (standalone)
ReferringOrg (standalone)
RegistrationForm → IntakeForm → Client → Incident
```

## CLIENT STATUS CONSTRAINTS

| Status | Must Have | Must NOT Have |
|--------|-----------|---------------|
| `waiting_list` | - | care_start_date, discharge_date |
| `in_care` | care_start_date | discharge_date |
| `discharged` | care_start_date, discharge_date, discharge_status | - |
